WITH enriched AS (
  SELECT
    item_category,
    interaction_type,
    year(derived_timestamp)  AS year,
    month(derived_timestamp) AS month,
    day(derived_timestamp)   AS day,
    hour(derived_timestamp)  AS hour
  FROM "qbrk"."search_golden_dataset"
  WHERE item_category IN ('transactions','reports','ledger_accounts','jump_to')
),

agg AS (
  SELECT
    item_category,
    year,
    month,
    day,
    hour,

    SUM(CASE WHEN interaction_type IN ('POSITIVE_IMPLICIT','SHORT_LIVED_CLICK') THEN 1 ELSE 0 END) AS clicked,
    SUM(CASE WHEN interaction_type = 'POSITIVE_IMPLICIT' THEN 1 ELSE 0 END) AS positive_implicit_clicks,
    SUM(CASE WHEN interaction_type = 'SHORT_LIVED_CLICK' THEN 1 ELSE 0 END) AS short_lived_clicks,
    SUM(CASE WHEN interaction_type = 'IMPRESSION' THEN 1 ELSE 0 END) AS impressions,
    SUM(CASE WHEN interaction_type NOT IN ('POSITIVE_IMPLICIT','SHORT_LIVED_CLICK') THEN 1 ELSE 0 END) AS not_clicked,

    CAST(SUM(CASE WHEN interaction_type IN ('POSITIVE_IMPLICIT','SHORT_LIVED_CLICK') THEN 1 ELSE 0 END) AS DOUBLE)
      / NULLIF(SUM(CASE WHEN interaction_type = 'IMPRESSION' THEN 1 ELSE 0 END),0) AS ctr
  FROM enriched
  GROUP BY item_category, year, month, day, hour
)

SELECT
  item_category,
  year,
  month,
  day,
  hour,
  clicked,
  positive_implicit_clicks,
  short_lived_clicks,
  impressions,
  not_clicked,
  ctr,
  100 * ctr AS ctr_pct,
  RANK() OVER (
    PARTITION BY year, month, day, hour
    ORDER BY ctr DESC
  ) AS ctr_rank
FROM agg;