SELECT
  t.*,
  CASE WHEN item_category = 'jump_to'
       THEN CAST(clicked AS DOUBLE) / NULLIF(impressions, 0)
  END AS jump_to_ctr
FROM (
  SELECT
    item_category,
    EXTRACT(year  FROM derived_timestamp) AS year,
    EXTRACT(month FROM derived_timestamp) AS month,
    EXTRACT(day   FROM derived_timestamp) AS day,
    EXTRACT(hour  FROM derived_timestamp) AS hour,

    SUM(CASE WHEN interaction_type IN ('POSITIVE_IMPLICIT','SHORT_LIVED_CLICK') THEN 1 ELSE 0 END) AS clicked,
    SUM(CASE WHEN interaction_type = 'POSITIVE_IMPLICIT' THEN 1 ELSE 0 END) AS positive_implicit_clicks,
    SUM(CASE WHEN interaction_type = 'SHORT_LIVED_CLICK' THEN 1 ELSE 0 END) AS short_lived_clicks,
    SUM(CASE WHEN interaction_type = 'IMPRESSION'        THEN 1 ELSE 0 END) AS impressions,

    CAST(
      SUM(CASE WHEN interaction_type IN ('POSITIVE_IMPLICIT','SHORT_LIVED_CLICK') THEN 1 ELSE 0 END) AS DOUBLE
    ) / NULLIF(
      SUM(CASE WHEN interaction_type = 'IMPRESSION' THEN 1 ELSE 0 END), 0
    ) AS ctr
  FROM project.dataset.search_golden_data
  WHERE item_category IN ('jump_to','transactions','reports','contacts','ledger_accounts')
  GROUP BY item_category, year, month, day, hour
) t;