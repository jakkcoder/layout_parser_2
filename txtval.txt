WITH base AS (
  SELECT
    sg.item_category,
    -- parse timestamp if it's a string; otherwise just use sg.derived_timestamp
    from_iso8601_timestamp(sg.derived_timestamp) AS ts,
    sg.ui_action,
    sg.interaction_type
  FROM qbkr.search_golden_dataset AS sg
  WHERE sg.item_category NOT IN ('transactions','content','reports','ledger_accounts','jump_to')
),
agg AS (
  SELECT
    item_category,
    EXTRACT(YEAR  FROM ts) AS run_year,
    EXTRACT(MONTH FROM ts) AS run_month,
    EXTRACT(DAY   FROM ts) AS run_day,
    EXTRACT(HOUR  FROM ts) AS run_hour,

    SUM(CASE WHEN interaction_type = 'SHORT_LIVED_CLICK'
              AND ui_action = 'clicked' THEN 1 ELSE 0 END) AS short_lived_clicks,

    SUM(CASE WHEN interaction_type = 'POSITIVE_IMPLICIT'
              AND ui_action = 'clicked' THEN 1 ELSE 0 END) AS positive_implicit_clicks,

    SUM(CASE WHEN ui_action = 'clicked' THEN 1 ELSE 0 END) AS clicked,
    SUM(CASE WHEN ui_action <> 'clicked' THEN 1 ELSE 0 END) AS not_clicked,

    -- SAFE_DIVIDE replacement
    CAST(SUM(CASE WHEN ui_action = 'clicked' THEN 1 ELSE 0 END) AS double)
      / NULLIF(COUNT(*), 0) AS click_through_rate
  FROM base
  GROUP BY
    item_category,
    EXTRACT(YEAR  FROM ts),
    EXTRACT(MONTH FROM ts),
    EXTRACT(DAY   FROM ts),
    EXTRACT(HOUR  FROM ts)
)
SELECT * FROM agg;